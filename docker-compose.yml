services:
  frontend-app:
    container_name: frontend-app
    build:
      context: .
      dockerfile: docker/dev/php/Dockerfile
      target: php-runtime
      args:
        UID: ${UID}
        GID: ${GID}
    command: php-fpm
    volumes:
      - ./src:/var/www/html
    depends_on:
      frontend-redis:
        condition: service_healthy
    expose:
      - "9000"
    networks:
      - frontend-internal
      - microservices

  frontend-nginx:
    container_name: frontend-nginx
    image: nginx:1.27
    volumes:
      - ./src:/var/www/html
      - ./docker/dev/nginx/default.conf:/etc/nginx/conf.d/default.conf
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${APP_DOMAIN}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
    depends_on:
      frontend-app:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/80'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - frontend-internal
      - web

  frontend-redis:
    image: redis:7-alpine
    container_name: frontend-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - frontend-internal

networks:
  frontend-internal:
    driver: bridge
  web:
    external: true
  microservices:
    external: true

volumes:
  redis_data:
