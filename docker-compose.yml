services:
  frontend-app:
    container_name: frontend-app
    build:
      context: .
      dockerfile: docker/dev/php/Dockerfile
      target: php-runtime
      args:
        UID: ${UID}
        GID: ${GID}
    command: php-fpm
    environment:
      - PHP_IDE_CONFIG="serverName=frontend-docker"
      - XDEBUG_CONFIG="client_host=host.docker.internal"
      - RABBITMQ_HOST=${RABBITMQ_HOST:-rabbitmq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER:-admin}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD:-secret}
    volumes:
      - ./src:/var/www/html
      - ./docker/dev/php/xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini:ro
    depends_on:
      frontend-redis:
        condition: service_healthy
      frontend-vite:
        condition: service_started
    expose:
      - "9000"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks:
      - frontend-internal
      - microservices

  frontend-vite:
    container_name: frontend-vite
    image: node:22-alpine
    working_dir: /app
    volumes:
      - ./src:/app
    command: sh -c "npm install && npm run dev -- --host"
    ports:
      - "5174:5174"
    networks:
      - frontend-internal

  frontend-nginx:
    container_name: frontend-nginx
    image: nginx:1.27
    volumes:
      - ./src:/var/www/html
      - ./docker/dev/nginx/default.conf:/etc/nginx/conf.d/default.conf
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${APP_DOMAIN}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
    depends_on:
      frontend-app:
        condition: service_started
      frontend-vite:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/80'"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - frontend-internal
      - web

  frontend-redis:
    image: redis:7-alpine
    container_name: frontend-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - frontend-internal

networks:
  frontend-internal:
    driver: bridge
  web:
    external: true
  microservices:
    external: true

volumes:
  redis_data:
